- hosts: [all]
  name: Do the thing
  pre_tasks:
    - name: End play if not on MacOS or Fedora
      ansible.builtin.meta: end_host
      tags: [always]
      when:
        - ansible_system != 'Darwin' and ansible_facts['distribution'] != "Fedora"
    - name: Gather package facts
      tags: [always]
      ansible.builtin.package_facts:
        manager: auto
      when: ansible_system == 'Linux'
    - name: Set variant fact
      tags: [always]
      ansible.builtin.set_fact:
        variant: "{{ ansible_facts.packages | select('search', 'fedora-release-identity-') | first | split('-') | last }}"
      when: ansible_distribution == 'Fedora'
    - name: Group by distribution
      tags: [always]
      ansible.builtin.group_by:
        key: "{{ ansible_distribution | lower | replace(' ', '_') }}"
    - name: Group by distribution and version
      tags: [always]
      ansible.builtin.group_by:
        key: "{{ ansible_distribution | lower | replace(' ', '_') }}_{{ ansible_distribution_major_version | lower }}"
    - name: Group by variant
      tags: [always]
      ansible.builtin.group_by:
        key: "fedora_variant_{{ variant }}"
      when: ansible_distribution == 'Fedora'
  tasks:
    - ansible.builtin.import_role: # noqa name[missing]
        name: base
      tags: [base]
    - ansible.builtin.import_role: # noqa name[missing]
        name: framework
      tags: [framework]
    - ansible.builtin.import_role: # noqa name[missing]
        name: graphical
      tags: [graphical]
      when: is_graphical
    - ansible.builtin.import_role: # noqa name[missing]
        name: user
      tags: [user]
